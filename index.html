<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Multi-Crypto Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Bot Trading Multi-Crypto Pro
                </h1>
                <p class="text-gray-400 mt-2">Trading r√©el avec PancakeSwap ‚Ä¢ Indicateurs techniques avanc√©s</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="openDCASwap()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg font-semibold transition-all">
                    <span>üîÑ</span>
                    DCA/Swap
                    <span>‚Üó</span>
                </button>
                
                <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600">
                    <span>üëõ</span>
                    <span id="walletText">Connecter MetaMask</span>
                </button>
            </div>
        </div>

        <!-- S√©lection Crypto -->
        <div id="cryptoSelector" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">S√©lectionner la Crypto √† Trader</h3>
                <button onclick="fetchCryptoList()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all">
                    <span id="refreshIcon">üîÑ</span>
                    <span id="refreshText">Actualiser</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        Cryptomonnaie <span id="cryptoCount"></span>
                    </label>
                    <select id="cryptoSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option>Chargement...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="cryptoInfo">üíé = Trading r√©el OK ‚Ä¢ üéÆ = Simulation uniquement</p>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode de Trading</label>
                    <select id="tradingMode" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option value="simulation">üéÆ Mode Simulation</option>
                        <option value="real">üíé Mode R√©el (PancakeSwap)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="modeInfo">‚úÖ Pas de frais, donn√©es r√©elles</p>
                </div>
            </div>
        </div>

        <!-- Approbation USDT -->
        <div id="approvalSection" class="bg-gradient-to-r from-orange-400/20 to-red-500/20 border-2 border-orange-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>‚ö†Ô∏è</span>
                Approuver USDT pour le Trading R√©el
            </h3>
            <p class="text-gray-300 mb-4">
                Pour trader en mode r√©el sur PancakeSwap, vous devez d'abord approuver le contrat √† utiliser vos USDT.
                <br />
                <span class="text-sm text-gray-400">Cette op√©ration est n√©cessaire une seule fois.</span>
            </p>
            <button onclick="approveUSDT()" id="approveBtn" class="px-8 py-3 bg-gradient-to-r from-orange-400 to-red-500 hover:from-orange-500 hover:to-red-600 rounded-lg font-semibold transition-all">
                Approuver USDT
            </button>
        </div>

        <!-- Capital Trading -->
        <div id="capitalSection" class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border-2 border-yellow-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üéØ</span>
                D√©finir votre capital de trading en USDT
            </h3>
            <p class="text-gray-300 mb-4">
                Entrez le montant en USDT que vous souhaitez utiliser pour le trading automatique.
                <br />
                <span class="text-sm text-gray-400">Solde disponible: <span id="availableBalance">0</span> USDT</span>
            </p>
            <div class="flex gap-4">
                <input type="number" id="capitalInput" placeholder="Ex: 1000" step="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400">
                <button onclick="setCapital()" class="px-8 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 rounded-lg font-semibold transition-all">
                    Valider
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8 hidden">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Capital USDT</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="capitalDisplay">0</span></p>
                <p class="text-xs text-gray-500">Solde: $<span id="balanceDisplay">0</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Prix <span id="cryptoName">BTC</span></p>
                <p class="text-xl font-bold mt-1">$<span id="currentPrice">...</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Profit Net</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="profitDisplay">0.00</span></p>
                <p class="text-xs text-gray-400">(<span id="profitPercent">0</span>%)</p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Commission</p>
                <p class="text-xl font-bold mt-1 text-purple-400"><span id="commissionBNB">0.000000</span> BNB</p>
                <p class="text-xs text-gray-500">‚âà $<span id="commissionUSD">0.00</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Mode</p>
                <p class="text-xl font-bold mt-1" id="modeDisplay">üéÆ SIM</p>
                <p class="text-xs text-gray-400" id="modeText">Simulation</p>
            </div>
        </div>

        <!-- Indicateurs Techniques -->
        <div id="indicatorsSection" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üìä</span>
                Indicateurs Techniques
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">RSI (14)</p>
                    <p class="text-2xl font-bold text-yellow-400" id="rsiValue">50.00</p>
                    <p class="text-xs text-gray-500 mt-1" id="rsiStatus">Neutre</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">MACD</p>
                    <p class="text-2xl font-bold text-green-400" id="macdValue">0.0000</p>
                    <p class="text-xs text-gray-500 mt-1" id="macdStatus">Haussier</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">EMA 20</p>
                    <p class="text-2xl font-bold text-blue-400">$<span id="ema20Value">0</span></p>
                    <p class="text-xs text-gray-500 mt-1" id="ema20Status">‚Üë Au-dessus</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">EMA 50</p>
                    <p class="text-2xl font-bold text-purple-400">$<span id="ema50Value">0</span></p>
                    <p class="text-xs text-gray-500 mt-1" id="ema50Status">Golden Cross</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">Bollinger</p>
                    <p class="text-sm font-bold text-green-400">‚Üë $<span id="bbUpper">0</span></p>
                    <p class="text-sm font-bold text-gray-400">‚Ä¢ $<span id="bbMiddle">0</span></p>
                    <p class="text-sm font-bold text-red-400">‚Üì $<span id="bbLower">0</span></p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Strategies & Trades -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Strategies -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">Strat√©gies de Trading</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="strategiesGrid">
                        <!-- Strategies will be populated by JS -->
                    </div>
                </div>

                <!-- Trades History -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Historique des Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">D√©marrer</span>
                        </button>
                    </div>
                    
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö†Ô∏è</span>
                            <p>Aucun trade pour le moment</p>
                            <p class="text-sm mt-2">D√©marrez le bot pour commencer</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Param√®tres</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">% du capital par trade</label>
                        <input type="number" id="tradePercent" value="10" min="1" max="100" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">Par trade: $<span id="tradeAmount">0</span> USDT</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Slippage (%)</label>
                        <input type="number" id="slippage" value="0.5" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Stop Loss (%)</label>
                        <input type="number" id="stopLoss" value="5" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Take Profit (%)</label>
                        <input type="number" id="takeProfit" value="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                    </div>
                </div>

                <div class="mt-6 p-4 bg-green-400/10 border border-green-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-green-400">üí∞</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-green-400 mb-1">Soldes Wallet</p>
                            <p>BNB: <span id="bnbBalance">0</span> ($<span id="bnbValue">0</span>)</p>
                            <p>USDT: $<span id="usdtBalance">0</span></p>
                            <p class="text-xs mt-1 text-gray-400">Prix BNB: $<span id="bnbPrice">620</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-blue-400/10 border border-blue-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-blue-400">üìä</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-blue-400 mb-1">‚úÖ Statut</p>
                            <p>MetaMask: <span id="walletStatus">üî¥ D√©connect√©</span></p>
                            <p>Binance API: <span id="apiStatus">üü° Connexion...</span></p>
                            <p>Indicateurs: <span id="indicatorsStatus">üü° Chargement...</span></p>
                            <p>Cryptos: <span id="cryptosLoaded">0</span> disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';
        const COMMISSION_RATE = 0.0001;
        const COMMISSION_WALLET = '0x3bf6f7bb2fc3fa4685138303fe593fc8b5b475ba';

        // State
        let state = {
            account: null,
            isConnected: false,
            balanceBNB: '0',
            balanceUSDT: '0',
            selectedCrypto: 'BTCUSDT',
            cryptoList: [],
            currentPrice: null,
            priceHistory: [],
            tradingCapital: 0,
            capitalSet: false,
            tradingMode: 'simulation',
            usdtApproved: false,
            botRunning: false,
            trades: [],
            portfolio: { totalValue: 0, profit: 0, profitPercent: 0, commission: 0 },
            totalCommissionBNB: 0,
            bnbPrice: 620,
            indicators: { rsi: 50, macd: { histogram: 0 }, ema20: 0, ema50: 0, bollingerBands: { upper: 0, middle: 0, lower: 0 } },
            selectedStrategy: 'scalping'
        };

        let ws = null;
        let botInterval = null;
        let lastTradeTime = 0;

        // Token addresses
        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',
            'ADAUSDT': '0x3EE2200Efb3400fAbB9AacF31297cBdD1d435D47',
            'DOGEUSDT': '0xbA2aE424d960c26247Dd6c32edC70B295c744C43',
            'XRPUSDT': '0x1D2F0da169ceB9fC7B3144628dB156f3F6c60dBE',
            'SOLUSDT': '0x570A5D26f7765Ecb712C0924E4De545B89fD43dF'
        };

        // Strategies
        const strategies = {
            scalping: { name: 'Scalping', description: 'Trading rapide bas√© sur RSI et MACD', risk: 'Moyen', timeframe: '1-5 min', minTradeInterval: 30000, indicators: ['RSI', 'MACD', 'Volume'] },
            swing: { name: 'Swing Trading', description: 'Positions sur plusieurs jours avec EMA', risk: 'Faible', timeframe: '1-7 jours', minTradeInterval: 300000, indicators: ['EMA 20/50', 'RSI', 'Bollinger Bands'] },
            arbitrage: { name: 'Arbitrage', description: 'Exploite les diff√©rences de prix entre DEX', risk: 'Faible', timeframe: 'Instantan√©', minTradeInterval: 60000, indicators: ['Prix Multi-DEX', 'Liquidit√©'] },
            grid: { name: 'Grid Trading', description: 'Niveaux de prix automatiques', risk: 'Moyen', timeframe: 'Continu', minTradeInterval: 120000, indicators: ['Niveaux de prix', 'Volatilit√©'] }
        };

        // Initialize
        function init() {
            renderStrategies();
            fetchCryptoList();
            
            document.getElementById('tradingMode').addEventListener('change', (e) => {
                state.tradingMode = e.target.value;
                updateUI();
            });
            
            document.getElementById('cryptoSelect').addEventListener('change', (e) => {
                state.selectedCrypto = e.target.value;
                connectWebSocket();
            });
        }

        function renderStrategies() {
            const grid = document.getElementById('strategiesGrid');
            grid.innerHTML = Object.entries(strategies).map(([key, strategy]) => `
                <div onclick="selectStrategy('${key}')" class="p-4 rounded-lg border-2 ${state.selectedStrategy === key ? 'border-yellow-400 bg-yellow-400/10' : 'border-slate-600'} cursor-pointer transition-all hover:border-slate-500">
                    <h3 class="font-bold text-lg mb-2">${strategy.name}</h3>
                    <p class="text-gray-400 text-sm mb-3">${strategy.description}</p>
                    <div class="flex gap-2 flex-wrap mb-3">
                        ${strategy.indicators.map(ind => `<span class="text-xs bg-blue-400/20 text-blue-400 px-2 py-1 rounded">${ind}</span>`).join('')}
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Risque: <span class="text-yellow-400">${strategy.risk}</span></span>
                        <span class="text-gray-500">${strategy.timeframe}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectStrategy(key) {
            state.selectedStrategy = key;
            renderStrategies();
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask n\'est pas install√©. Veuillez l\'installer depuis https://metamask.io');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== '0x38') {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'BNB Smart Chain',
                            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                            rpcUrls: ['https://bsc-dataseed1.binance.org'],
                            blockExplorerUrls: ['https://bscscan.com']
                        }]
                    });
                }
                
                const balanceResult = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                
                state.account = accounts[0];
                state.balanceBNB = (parseInt(balanceResult, 16) / 1e18).toFixed(4);
                state.balanceUSDT = '1000'; // Simplified
                state.isConnected = true;
                
                updateUI();
                fetchCryptoList();
            } catch (error) {
                console.error('Erreur connexion:', error);
                alert('Erreur lors de la connexion: ' + error.message);
            }
        }

        async function fetchCryptoList() {
            document.getElementById('refreshIcon').classList.add('animate-spin');
            document.getElementById('refreshText').textContent = 'Chargement...';
            
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                const data = await response.json();
                
                state.cryptoList = data
                    .filter(item => item.symbol.endsWith('USDT') && !item.symbol.includes('UP') && !item.symbol.includes('DOWN'))
                    .map(item => ({
                        symbol: item.symbol,
                        name: item.symbol.replace('USDT', ''),
                        price: parseFloat(item.lastPrice),
                        priceChange: parseFloat(item.priceChangePercent),
                        realTradingAvailable: !!TOKEN_ADDRESSES[item.symbol]
                    }))
                    .slice(0, 100);
                
                const select = document.getElementById('cryptoSelect');
                select.innerHTML = state.cryptoList.map(crypto => 
                    `<option value="${crypto.symbol}">${crypto.name} - $${crypto.price.toFixed(2)} (${crypto.priceChange >= 0 ? '+' : ''}${crypto.priceChange.toFixed(2)}%) ${crypto.realTradingAvailable ? 'üíé' : 'üéÆ'}</option>`
                ).join('');
                
                if (state.cryptoList.length > 0 && !state.selectedCrypto) {
                    state.selectedCrypto = state.cryptoList[0].symbol;
                    connectWebSocket();
                }
                
                updateUI();
            } catch (error) {
                console.error('Erreur chargement cryptos:', error);
            } finally {
                document.getElementById('refreshIcon').classList.remove('animate-spin');
                document.getElementById('refreshText').textContent = 'Actualiser';
            }
        }

        function connectWebSocket() {
            if (ws) ws.close();
            
            const symbol = state.selectedCrypto.toLowerCase();
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@ticker`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                state.currentPrice = parseFloat(data.c);
                state.priceHistory.push(state.currentPrice);
                if (state.priceHistory.length > 100) state.priceHistory.shift();
                
                updateIndicators();
                updateUI();
            };
        }

        function updateIndicators() {
            if (state.priceHistory.length < 50) return;
            
            state.indicators.rsi = calculateRSI(state.priceHistory);
            state.indicators.ema20 = calculateEMA(state.priceHistory, 20);
            state.indicators.ema50 = calculateEMA(state.priceHistory, 50);
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateEMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            
            const multiplier = 2 / (period + 1);
            let ema = prices.slice(0, period).reduce((a, b) => a + b) / period;
            
            for (let i = period; i < prices.length; i++) {
                ema = (prices[i] - ema) * multiplier + ema;
            }
            
            return ema;
        }

        function setCapital() {
            const capital = parseFloat(document.getElementById('capitalInput').value);
            if (capital > 0 && capital <= parseFloat(state.balanceUSDT)) {
                state.tradingCapital = capital;
                state.capitalSet = true;
                updateUI();
