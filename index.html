<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Trading Multi-Crypto Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Bot Trading Multi-Crypto Pro
                </h1>
                <p class="text-gray-400 mt-2">Trading r√©el avec PancakeSwap ‚Ä¢ Prix en temps r√©el Binance ‚Ä¢ Commission 0.01%</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="openDCASwap()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg font-semibold transition-all">
                    <span>üîÑ</span>
                    DCA/Swap
                    <span>‚Üó</span>
                </button>
                
                <button onclick="connectWallet()" id="connectBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600">
                    <span>üëõ</span>
                    <span id="walletText">Connecter MetaMask</span>
                </button>
            </div>
        </div>

        <!-- S√©lection Crypto -->
        <div id="cryptoSelector" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">S√©lectionner la Crypto √† Trader</h3>
                <button onclick="fetchCryptoList()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-all">
                    <span id="refreshIcon">üîÑ</span>
                    <span id="refreshText">Actualiser</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        Cryptomonnaie <span id="cryptoCount"></span>
                    </label>
                    <select id="cryptoSelect" onchange="changeCrypto()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option>Chargement...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">üíé = Trading r√©el OK ‚Ä¢ üéÆ = Simulation uniquement</p>
                    <p class="text-xs text-green-400 mt-1">‚úÖ Prix en temps r√©el via WebSocket Binance</p>
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Mode de Trading</label>
                    <select id="tradingMode" onchange="changeTradingMode()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400 text-lg font-semibold cursor-pointer">
                        <option value="simulation">üéÆ Mode Simulation</option>
                        <option value="real">üíé Mode R√©el (PancakeSwap)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="modeInfo">‚úÖ Pas de frais, donn√©es r√©elles</p>
                </div>
            </div>
        </div>

        <!-- Approbation USDT -->
        <div id="approvalSection" class="bg-gradient-to-r from-orange-400/20 to-red-500/20 border-2 border-orange-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>‚ö†Ô∏è</span>
                Approuver USDT pour le Trading R√©el
            </h3>
            <p class="text-gray-300 mb-4">
                Pour trader en mode r√©el sur PancakeSwap, vous devez d'abord approuver le contrat √† utiliser vos USDT.
                <br />
                <span class="text-sm text-gray-400">Cette op√©ration est n√©cessaire une seule fois.</span>
            </p>
            <button onclick="approveUSDT()" id="approveBtn" class="px-8 py-3 bg-gradient-to-r from-orange-400 to-red-500 hover:from-orange-500 hover:to-red-600 rounded-lg font-semibold transition-all">
                Approuver USDT
            </button>
        </div>

        <!-- Capital Trading -->
        <div id="capitalSection" class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border-2 border-yellow-400 rounded-xl p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üéØ</span>
                D√©finir votre capital de trading en USDT
            </h3>
            <p class="text-gray-300 mb-4">
                Entrez le montant en USDT que vous souhaitez utiliser pour le trading automatique.
                <br />
                <span class="text-sm text-gray-400">Solde disponible: <span id="availableBalance">0</span> USDT</span>
            </p>
            <div class="flex gap-4">
                <input type="number" id="capitalInput" placeholder="Ex: 1000" step="10" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-400">
                <button onclick="setCapital()" class="px-8 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 rounded-lg font-semibold transition-all">
                    Valider
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="statsCards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8 hidden">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Capital USDT</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="capitalDisplay">0</span></p>
                <p class="text-xs text-gray-500">Solde: $<span id="balanceDisplay">0</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Prix <span id="cryptoName">BTC</span></p>
                <p class="text-xl font-bold mt-1" id="priceDisplay">
                    <span class="text-green-400">üü¢</span> $<span id="currentPrice">...</span>
                </p>
                <p class="text-xs" id="priceChangeDisplay">Chargement...</p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Profit Net</p>
                <p class="text-xl font-bold mt-1 text-green-400">$<span id="profitDisplay">0.00</span></p>
                <p class="text-xs text-gray-400">(<span id="profitPercent">0</span>%)</p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Commission (0.01%)</p>
                <p class="text-xl font-bold mt-1 text-purple-400"><span id="commissionBNB">0.000000</span> BNB</p>
                <p class="text-xs text-gray-500">‚âà $<span id="commissionUSD">0.00</span></p>
            </div>
            
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-4">
                <p class="text-gray-400 text-xs">Mode</p>
                <p class="text-xl font-bold mt-1" id="modeDisplay">üéÆ SIM</p>
                <p class="text-xs text-gray-400" id="modeText">Simulation</p>
            </div>
        </div>

        <!-- Indicateurs Techniques -->
        <div id="indicatorsSection" class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span>üìä</span>
                Indicateurs Techniques - <span id="indicatorsCrypto">BTC</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">RSI (14)</p>
                    <p class="text-2xl font-bold text-yellow-400" id="rsiValue">50.00</p>
                    <p class="text-xs text-gray-500 mt-1" id="rsiStatus">Neutre</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">MACD</p>
                    <p class="text-2xl font-bold text-green-400" id="macdValue">0.0000</p>
                    <p class="text-xs text-gray-500 mt-1" id="macdStatus">Haussier</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">EMA 20</p>
                    <p class="text-2xl font-bold text-blue-400">$<span id="ema20Value">0</span></p>
                    <p class="text-xs text-gray-500 mt-1" id="ema20Status">Calcul...</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">EMA 50</p>
                    <p class="text-2xl font-bold text-purple-400">$<span id="ema50Value">0</span></p>
                    <p class="text-xs text-gray-500 mt-1" id="ema50Status">Calcul...</p>
                </div>
                
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <p class="text-gray-400 text-sm mb-1">Bollinger</p>
                    <p class="text-sm font-bold text-green-400">‚Üë $<span id="bbUpper">0</span></p>
                    <p class="text-sm font-bold text-gray-400">‚Ä¢ $<span id="bbMiddle">0</span></p>
                    <p class="text-sm font-bold text-red-400">‚Üì $<span id="bbLower">0</span></p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Strategies & Trades -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Strategies -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">Strat√©gies de Trading</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="strategiesGrid">
                        <!-- Strategies will be populated by JS -->
                    </div>
                </div>

                <!-- Trades History -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Historique des Trades</h2>
                        <button onclick="toggleBot()" id="toggleBotBtn" disabled class="flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-gray-600 cursor-not-allowed">
                            <span id="botIcon">‚ñ∂Ô∏è</span>
                            <span id="botText">D√©marrer</span>
                        </button>
                    </div>
                    
                    <div id="tradesContainer">
                        <div class="text-center py-8 text-gray-400">
                            <span class="text-4xl">‚ö†Ô∏è</span>
                            <p>Aucun trade pour le moment</p>
                            <p class="text-sm mt-2">D√©marrez le bot pour commencer</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Param√®tres</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">% du capital par trade</label>
                        <input type="number" id="tradePercent" value="10" min="1" max="100" onchange="updateTradeAmount()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                        <p class="text-xs text-gray-400 mt-1">Par trade: $<span id="tradeAmount">0</span> USDT</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Slippage (%)</label>
                        <input type="number" id="slippage" value="0.5" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Stop Loss (%)</label>
                        <input type="number" id="stopLoss" value="5" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Take Profit (%)</label>
                        <input type="number" id="takeProfit" value="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-400">
                    </div>
                </div>

                <div class="mt-6 p-4 bg-green-400/10 border border-green-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-green-400">üí∞</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-green-400 mb-1">Soldes Wallet</p>
                            <p>BNB: <span id="bnbBalance">0</span> ($<span id="bnbValue">0</span>)</p>
                            <p>USDT: $<span id="usdtBalance">0</span></p>
                            <p class="text-xs mt-1 text-gray-400">Prix BNB: $<span id="bnbPrice">620</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-purple-400/10 border border-purple-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-purple-400">üíé</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-purple-400 mb-1">Commission 0.01%</p>
                            <p>Pr√©lev√©e en BNB sur chaque trade</p>
                            <p class="text-xs mt-1 text-gray-400">Total: <span id="totalCommBNB">0.000000</span> BNB</p>
                            <p class="text-xs text-gray-400 break-all">Wallet: 0x3bf6...75ba</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-blue-400/10 border border-blue-400/30 rounded-lg">
                    <div class="flex gap-2">
                        <span class="text-blue-400">üìä</span>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold text-blue-400 mb-1">‚úÖ Statut</p>
                            <p>MetaMask: <span id="walletStatus">üî¥ D√©connect√©</span></p>
                            <p>Binance WS: <span id="apiStatus">üü° Connexion...</span></p>
                            <p>Indicateurs: <span id="indicatorsStatus">üü° Chargement...</span></p>
                            <p>Cryptos: <span id="cryptosLoaded">0</span> disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        const USDT_CONTRACT = '0x55d398326f99059fF775485246999027B3197955';
        const COMMISSION_RATE = 0.0001; // 0.01%
        const COMMISSION_WALLET = '0x3bf6f7bb2fc3fa4685138303fe593fc8b5b475ba';

        // State
        let state = {
            account: null,
            isConnected: false,
            balanceBNB: '0',
            balanceUSDT: '0',
            selectedCrypto: 'BTCUSDT',
            cryptoList: [],
            currentPrice: null,
            priceChange: 0,
            priceHistory: [],
            tradingCapital: 0,
            capitalSet: false,
            tradingMode: 'simulation',
            usdtApproved: false,
            botRunning: false,
            trades: [],
            portfolio: { totalValue: 0, profit: 0, profitPercent: 0, commission: 0 },
            totalCommissionBNB: 0,
            bnbPrice: 620,
            indicators: { 
                rsi: 50, 
                macd: { histogram: 0 }, 
                ema20: 0, 
                ema50: 0, 
                bollingerBands: { upper: 0, middle: 0, lower: 0 } 
            },
            selectedStrategy: 'scalping'
        };

        let ws = null;
        let botInterval = null;
        let lastTradeTime = 0;

        // Token addresses
        const TOKEN_ADDRESSES = {
            'BTCUSDT': '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',
            'ETHUSDT': '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',
            'BNBUSDT': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',
            'ADAUSDT': '0x3EE2200Efb3400fAbB9AacF31297cBdD1d435D47',
            'DOGEUSDT': '0xbA2aE424d960c26247Dd6c32edC70B295c744C43',
            'XRPUSDT': '0x1D2F0da169ceB9fC7B3144628dB156f3F6c60dBE',
            'SOLUSDT': '0x570A5D26f7765Ecb712C0924E4De545B89fD43dF',
            'MATICUSDT': '0xCC42724C6683B7E57334c4E856f4c9965ED682bD',
            'LINKUSDT': '0xF8A0BF9cF54Bb92F17374d9e9A321E6a111a51bD'
        };

        // Strategies
        const strategies = {
            scalping: { name: 'Scalping', description: 'Trading rapide bas√© sur RSI et MACD', risk: 'Moyen', timeframe: '1-5 min', minTradeInterval: 30000, indicators: ['RSI', 'MACD', 'Volume'] },
            swing: { name: 'Swing Trading', description: 'Positions sur plusieurs jours avec EMA', risk: 'Faible', timeframe: '1-7 jours', minTradeInterval: 300000, indicators: ['EMA 20/50', 'RSI', 'Bollinger Bands'] },
            arbitrage: { name: 'Arbitrage', description: 'Exploite les diff√©rences de prix entre DEX', risk: 'Faible', timeframe: 'Instantan√©', minTradeInterval: 60000, indicators: ['Prix Multi-DEX', 'Liquidit√©'] },
            grid: { name: 'Grid Trading', description: 'Niveaux de prix automatiques', risk: 'Moyen', timeframe: 'Continu', minTradeInterval: 120000, indicators: ['Niveaux de prix', 'Volatilit√©'] }
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Application charg√©e');
            renderStrategies();
            fetchCryptoList();
            fetchBNBPrice();
            
            setInterval(fetchBNBPrice, 30000);
        });

        function renderStrategies() {
            const grid = document.getElementById('strategiesGrid');
            grid.innerHTML = Object.entries(strategies).map(([key, strategy]) => `
                <div onclick="selectStrategy('${key}')" class="p-4 rounded-lg border-2 ${state.selectedStrategy === key ? 'border-yellow-400 bg-yellow-400/10' : 'border-slate-600 hover:border-slate-500'} cursor-pointer transition-all">
                    <h3 class="font-bold text-lg mb-2">${strategy.name}</h3>
                    <p class="text-gray-400 text-sm mb-3">${strategy.description}</p>
                    <div class="flex gap-2 flex-wrap mb-3">
                        ${strategy.indicators.map(ind => `<span class="text-xs bg-blue-400/20 text-blue-400 px-2 py-1 rounded">${ind}</span>`).join('')}
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Risque: <span class="text-yellow-400">${strategy.risk}</span></span>
                        <span class="text-gray-500">${strategy.timeframe}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectStrategy(key) {
            state.selectedStrategy = key;
            renderStrategies();
            console.log('‚úÖ Strat√©gie s√©lectionn√©e:', strategies[key].name);
        }

        function openDCASwap() {
            window.open('https://reboot17.vercel.app/', '_blank');
        }

        async function fetchBNBPrice() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                state.bnbPrice = parseFloat(data.price);
                document.getElementById('bnbPrice').textContent = state.bnbPrice.toFixed(2);
                console.log('üí∞ Prix BNB:', state.bnbPrice);
            } catch (error) {
                console.error('Erreur prix BNB:', error);
                // Utiliser un prix par d√©faut
                state.bnbPrice = 620;
                document.getElementById('bnbPrice').textContent = '620.00 (d√©faut)';
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask n\'est pas install√©. Veuillez l\'installer depuis https://metamask.io');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                console.log('üîå Connexion √† MetaMask...');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== '0x38') {
                    console.log('‚ö†Ô∏è Changement vers BSC...');
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'BNB Smart Chain',
                            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                            rpcUrls: ['https://bsc-dataseed1.binance.org'],
                            blockExplorerUrls: ['https://bscscan.com']
                        }]
                    });
                }
                
                const balanceResult = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                
                state.account = accounts[0];
                state.balanceBNB = (parseInt(balanceResult, 16) / 1e18).toFixed(4);
                state.balanceUSDT = '1000'; // Valeur par d√©faut pour la d√©mo
                state.isConnected = true;
                
                console.log('‚úÖ Wallet connect√©:', state.account);
                console.log('üí∞ BNB:', state.balanceBNB);
                
                updateUI();
                fetchCryptoList();
            } catch (error) {
                console.error('‚ùå Erreur connexion:', error);
                alert('Erreur lors de la connexion: ' + error.message);
            }
        }

        async function fetchCryptoList() {
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshText = document.getElementById('refreshText');
            refreshIcon.classList.add('animate-spin');
            refreshText.textContent = 'Chargement...';
            
            try {
                console.log('üìä Chargement des cryptos depuis Binance...');
                const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                const data = await response.json();
                
                state.cryptoList = data
                    .filter(item => 
                        item.symbol.endsWith('USDT') && 
                        !item.symbol.includes('UP') && 
                        !item.symbol.includes('DOWN') &&
                        parseFloat(item.volume) > 0
                    )
                    .map(item => ({
                        symbol: item.symbol,
                        name: item.symbol.replace('USDT', ''),
                        price: parseFloat(item.lastPrice),
                        priceChange: parseFloat(item.priceChangePercent),
                        volume: parseFloat(item.quoteVolume),
                        realTradingAvailable: !!TOKEN_ADDRESSES[item.symbol]
                    }))
                    .sort((a, b) => b.volume - a.volume)
                    .slice(0, 100);
                
                console.log('‚úÖ Cryptos charg√©es:', state.cryptoList.length);
                
                const select = document.getElementById('cryptoSelect');
                select.innerHTML = state.cryptoList.map(crypto => {
                    const priceStr = crypto.price >= 1 ? crypto.price.toFixed(2) : crypto.price.toFixed(6);
                    return `<option value="${crypto.symbol}">${crypto.name} - ${priceStr} (${crypto.priceChange >= 0 ? '+' : ''}${crypto.priceChange.toFixed(2)}%) ${crypto.realTradingAvailable ? 'üíé' : 'üéÆ'}</option>`;
                }).join('');
                
                if (state.cryptoList.length > 0) {
                    state.selectedCrypto = state.cryptoList[0].symbol;
                    connectWebSocket();
                }
                
                document.getElementById('cryptoCount').textContent = `(${state.cryptoList.length} disponibles)`;
                document.getElementById('cryptosLoaded').textContent = state.cryptoList.length;
                
                updateUI();
            } catch (error) {
                console.error('‚ùå Erreur chargement cryptos:', error);
                alert('Impossible de charger les cryptos. V√©rifiez votre connexion.');
            } finally {
                refreshIcon.classList.remove('animate-spin');
                refreshText.textContent = 'Actualiser';
            }
        }

        function changeCrypto() {
            const select = document.getElementById('cryptoSelect');
            state.selectedCrypto = select.value;
            console.log('üîÑ Changement de crypto:', state.selectedCrypto);
            
            // Reset price history
            state.priceHistory = [];
            state.currentPrice = null;
            
            connectWebSocket();
            updateUI();
        }

        function changeTradingMode() {
            const select = document.getElementById('tradingMode');
            state.tradingMode = select.value;
            console.log('üîÑ Mode de trading:', state.tradingMode);
            updateUI();
        }

        function connectWebSocket() {
            if (ws) {
                console.log('üîå Fermeture WebSocket pr√©c√©dent');
                ws.close();
            }
            
            const symbol = state.selectedCrypto.toLowerCase();
            const wsUrl = `wss://stream.binance.com:9443/ws/${symbol}@ticker`;
            console.log('üåê Connexion WebSocket:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connect√© pour', state.selectedCrypto);
                document.getElementById('apiStatus').innerHTML = 'üü¢ En ligne';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                state.currentPrice = parseFloat(data.c);
                state.priceChange = parseFloat(data.P);
                
                // Add to history
                state.priceHistory.push(state.currentPrice);
                if (state.priceHistory.length > 100) {
                    state.priceHistory.shift();
                }
                
                // Update indicators every 10 prices
                if (state.priceHistory.length % 10 === 0) {
                    updateIndicators();
                }
                
                updatePriceDisplay();
            };

            ws.onerror = (error) => {
                console.error('‚ùå Erreur WebSocket:', error);
                document.getElementById('apiStatus').innerHTML = 'üî¥ Erreur';
            };
            
            ws.onclose = () => {
                console.log('üîå WebSocket ferm√©');
                document.getElementById('apiStatus').innerHTML = 'üü° D√©connect√©';
            };
        }

        function updatePriceDisplay() {
            if (!state.currentPrice) return;
            
            const crypto = state.cryptoList.find(c => c.symbol === state.selectedCrypto);
            const priceStr = state.currentPrice >= 1 ? state.currentPrice.toFixed(2) : state.currentPrice.toFixed(6);
            
            document.getElementById('currentPrice').textContent = priceStr;
            document.getElementById('cryptoName').textContent = state.selectedCrypto.replace('USDT', '');
            document.getElementById('indicatorsCrypto').textContent = state.selectedCrypto.replace('USDT', '');
            
            const changeColor = state.priceChange >= 0 ? 'text-green-400' : 'text-red-400';
            document.getElementById('priceChangeDisplay').innerHTML = `<span class="${changeColor}">${state.priceChange >= 0 ? '+' : ''}${state.priceChange.toFixed(2)}%</span>`;
        }

        function updateIndicators() {
            if (state.priceHistory.length < 50) {
                document.getElementById('indicatorsStatus').innerHTML = 'üü° Collecte donn√©es...';
                return;
            }
            
            state.indicators.rsi = calculateRSI(state.priceHistory);
            state.indicators.ema20 = calculateEMA(state.priceHistory, 20);
            state.indicators.ema50 = calculateEMA(state.priceHistory, 50);
            state.indicators.macd = calculateMACD(state.priceHistory);
            state.indicators.bollingerBands = calculateBollingerBands(state.priceHistory);
            
            // Update RSI
            const rsiValue = state.indicators.rsi.toFixed(2);
            document.getElementById('rsiValue').textContent = rsiValue;
            document.getElementById('rsiValue').className = state.indicators.rsi < 30 ? 'text-2xl font-bold text-green-400' : 
                                                          state.indicators.rsi > 70 ? 'text-2xl font-bold text-red-400' : 
                                                          'text-2xl font-bold text-yellow-400';
            document.getElementById('rsiStatus').textContent = state.indicators.rsi < 30 ? 'Survendu' : 
                                                               state.indicators.rsi > 70 ? 'Surachet√©' : 'Neutre';
            
            // Update MACD
            document.getElementById('macdValue').textContent = state.indicators.macd.histogram.toFixed(4);
            document.getElementById('macdValue').className = state.indicators.macd.histogram >= 0 ? 
                'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
            document.getElementById('macdStatus').textContent = state.indicators.macd.histogram >= 0 ? 'Haussier' : 'Baissier';
            
            // Update EMAs
            const ema20Str = state.indicators.ema20 >= 1 ? state.indicators.ema20.toFixed(2) : state.indicators.ema20.toFixed(6);
            const ema50Str = state.indicators.ema50 >= 1 ? state.indicators.ema50.toFixed(2) : state.indicators.ema50.toFixed(6);
            document.getElementById('ema20Value').textContent = ema20Str;
            document.getElementById('ema50Value').textContent = ema50Str;
            document.getElementById('ema20Status').textContent = state.currentPrice > state.indicators.ema20 ? '‚Üë Au-dessus' : '‚Üì En-dessous';
            document.getElementById('ema50Status').textContent = state.indicators.ema20 > state.indicators.ema50 ? 'Golden Cross' : 'Death Cross';
            
            // Update Bollinger Bands
            const bbUpperStr = state.indicators.bollingerBands.upper >= 1 ? state.indicators.bollingerBands.upper.toFixed(2) : state.indicators.bollingerBands.upper.toFixed(6);
            const bbMiddleStr = state.indicators.bollingerBands.middle >= 1 ? state.indicators.bollingerBands.middle.toFixed(2) : state.indicators.bollingerBands.middle.toFixed(6);
            const bbLowerStr = state.indicators.bollingerBands.lower >= 1 ? state.indicators.bollingerBands.lower.toFixed(2) : state.indicators.bollingerBands.lower.toFixed(6);
            document.getElementById('bbUpper').textContent = bbUpperStr;
            document.getElementById('bbMiddle').textContent = bbMiddleStr;
            document.getElementById('bbLower').textContent = bbLowerStr;
            
            document.getElementById('indicatorsStatus').innerHTML = 'üü¢ Actifs';
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateEMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            
            const multiplier = 2 / (period + 1);
            let ema = prices.slice(0, period).reduce((a, b) => a + b) / period;
            
            for (let i = period; i < prices.length; i++) {
                ema = (prices[i] - ema) * multiplier + ema;
            }
            
            return ema;
        }

        function calculateMACD(prices) {
            if (prices.length < 26) return { value: 0, signal: 0, histogram: 0 };
            
            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);
            const macdLine = ema12 - ema26;
            const signalLine = macdLine * 0.9;
            
            return {
                value: macdLine,
                signal: signalLine,
                histogram: macdLine - signalLine
            };
        }

        function calculateBollingerBands(prices, period = 20, stdDev = 2) {
            if (prices.length < period) {
                const currentPrice = prices[prices.length - 1];
                return { upper: currentPrice * 1.02, middle: currentPrice, lower: currentPrice * 0.98 };
            }
            
            const recentPrices = prices.slice(-period);
            const middle = recentPrices.reduce((a, b) => a + b) / period;
            
            const variance = recentPrices.reduce((sum, price) => sum + Math.pow(price - middle, 2), 0) / period;
            const standardDeviation = Math.sqrt(variance);
            
            return {
                upper: middle + (standardDeviation * stdDev),
                middle: middle,
                lower: middle - (standardDeviation * stdDev)
            };
        }

        function setCapital() {
            const capital = parseFloat(document.getElementById('capitalInput').value);
            if (!capital || capital <= 0) {
                alert('‚ùå Veuillez entrer un montant valide');
                return;
            }
            
            if (capital > parseFloat(state.balanceUSDT)) {
                alert(`‚ùå Capital insuffisant. Maximum: ${state.balanceUSDT} USDT`);
                return;
            }
            
            state.tradingCapital = capital;
            state.capitalSet = true;
            console.log('‚úÖ Capital d√©fini:', capital, 'USDT');
            
            updateUI();
            alert(`‚úÖ Capital de trading d√©fini: ${capital} USDT`);
        }

        function updateTradeAmount() {
            if (!state.capitalSet) return;
            
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const amount = (state.tradingCapital * percent / 100).toFixed(2);
            document.getElementById('tradeAmount').textContent = amount;
        }

        async function approveUSDT() {
            if (!state.isConnected) {
                alert('‚ùå Veuillez connecter votre wallet');
                return;
            }

            try {
                const btn = document.getElementById('approveBtn');
                btn.textContent = 'Approbation en cours...';
                btn.disabled = true;
                
                console.log('üîê Approbation USDT...');
                
                const maxAmount = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
                const approveData = '0x095ea7b3' + 
                    PANCAKE_ROUTER.slice(2).padStart(64, '0') +
                    maxAmount.slice(2);
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: state.account,
                        to: USDT_CONTRACT,
                        data: approveData,
                        gas: '0x186A0',
                    }]
                });
                
                console.log('‚úÖ TX envoy√©e:', txHash);
                alert('Approbation en cours... TX: ' + txHash);
                
                state.usdtApproved = true;
                updateUI();
                alert('‚úÖ USDT approuv√© pour PancakeSwap !');
                
            } catch (error) {
                console.error('‚ùå Erreur approbation:', error);
                alert('Erreur: ' + error.message);
            } finally {
                const btn = document.getElementById('approveBtn');
                btn.textContent = 'Approuver USDT';
                btn.disabled = false;
            }
        }

        function toggleBot() {
            if (!state.isConnected) {
                alert('‚ùå Veuillez connecter votre wallet');
                return;
            }
            
            if (!state.capitalSet) {
                alert('‚ùå Veuillez d√©finir votre capital de trading');
                return;
            }
            
            if (!state.currentPrice) {
                alert('‚ùå Attendez que les prix se chargent...');
                return;
            }
            
            if (state.tradingMode === 'real') {
                const crypto = state.cryptoList.find(c => c.symbol === state.selectedCrypto);
                if (!crypto?.realTradingAvailable) {
                    alert('‚ö†Ô∏è Trading r√©el non disponible pour ' + state.selectedCrypto);
                    return;
                }
                
                if (!state.usdtApproved) {
                    alert('‚ùå Veuillez approuver USDT pour le trading r√©el');
                    return;
                }
            }
            
            state.botRunning = !state.botRunning;
            console.log('ü§ñ Bot:', state.botRunning ? 'D√âMARR√â' : 'ARR√äT√â');
            
            if (state.botRunning) {
                startBot();
                alert('‚úÖ Bot d√©marr√© en mode ' + (state.tradingMode === 'real' ? 'R√âEL üíé' : 'SIMULATION üéÆ'));
            } else {
                stopBot();
                alert('‚è∏Ô∏è Bot arr√™t√©');
            }
            
            updateUI();
        }

        function startBot() {
            const strategy = strategies[state.selectedStrategy];
            
            botInterval = setInterval(() => {
                if (state.priceHistory.length < 50) return;
                
                const now = Date.now();
                if (now - lastTradeTime < strategy.minTradeInterval) return;
                
                const signal = getTradeSignal();
                if (signal.signal && signal.confidence > 0.65) {
                    executeTrade(signal.signal, signal.confidence);
                }
            }, 5000);
        }

        function stopBot() {
            if (botInterval) {
                clearInterval(botInterval);
                botInterval = null;
            }
        }

        function getTradeSignal() {
            const { rsi, macd, ema20, ema50, bollingerBands } = state.indicators;
            
            switch (state.selectedStrategy) {
                case 'scalping':
                    if (rsi < 30 && macd.histogram > 0) return { signal: 'BUY', confidence: 0.8 };
                    if (rsi > 70 && macd.histogram < 0) return { signal: 'SELL', confidence: 0.8 };
                    break;
                    
                case 'swing':
                    if (ema20 > ema50 && rsi > 45 && rsi < 65) return { signal: 'BUY', confidence: 0.7 };
                    if (ema20 < ema50 && rsi > 35 && rsi < 55) return { signal: 'SELL', confidence: 0.7 };
                    break;
                    
                case 'arbitrage':
                    const priceVariation = Math.abs((state.currentPrice - bollingerBands.middle) / bollingerBands.middle);
                    if (priceVariation > 0.005) {
                        return { 
                            signal: state.currentPrice < bollingerBands.middle ? 'BUY' : 'SELL', 
                            confidence: 0.9 
                        };
                    }
                    break;
                    
                case 'grid':
                    if (state.currentPrice <= bollingerBands.lower * 1.01) return { signal: 'BUY', confidence: 0.75 };
                    if (state.currentPrice >= bollingerBands.upper * 0.99) return { signal: 'SELL', confidence: 0.75 };
                    break;
            }
            
            return { signal: null, confidence: 0 };
        }

        async function executeTrade(tradeType, confidence) {
            const percent = parseFloat(document.getElementById('tradePercent').value);
            const tradeAmountUSDT = (state.tradingCapital * percent) / 100;
            
            // Calcul de la commission en BNB
            const commissionUSDT = tradeAmountUSDT * COMMISSION_RATE;
            const commissionBNB = commissionUSDT / state.bnbPrice;
            
            console.log(`üí∞ Commission: ${commissionUSDT.toFixed(4)} USDT = ${commissionBNB.toFixed(6)} BNB`);
            console.log(`üì§ Envoi vers: ${COMMISSION_WALLET}`);
            
            // Simulation de variation de prix
            const priceVariation = (Math.random() * 0.01 - 0.005);
            const executionPrice = state.currentPrice * (1 + priceVariation);
            
            // En mode r√©el, envoyer la commission en BNB
            let txHash = null;
            if (state.tradingMode === 'real') {
                try {
                    // Envoyer la commission en BNB au wallet sp√©cifi√©
                    const commissionWei = BigInt(Math.floor(commissionBNB * 1e18)).toString(16);
                    
                    txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: state.account,
                            to: COMMISSION_WALLET,
                            value: '0x' + commissionWei.padStart(64, '0'),
                            gas: '0x5208', // 21000 gas pour transfert BNB
                        }]
                    });
                    
                    console.log('‚úÖ Commission envoy√©e:', txHash);
                } catch (error) {
                    console.error('‚ùå Erreur envoi commission:', error);
                    return;
                }
            }
            
            // Calcul du profit
            const profitPercent = tradeType === 'BUY' 
                ? (state.currentPrice - executionPrice) / executionPrice * 100
                : (executionPrice - state.currentPrice) / executionPrice * 100;
            
            const grossProfitUSDT = tradeAmountUSDT * (profitPercent / 100);
            const netProfitUSDT = grossProfitUSDT - commissionUSDT;
            
            const newTrade = {
                id: Date.now(),
                time: new Date().toLocaleTimeString(),
                pair: state.selectedCrypto,
                type: tradeType,
                amount: tradeAmountUSDT.toFixed(2),
                entryPrice: executionPrice.toFixed(6),
                currentPrice: state.currentPrice.toFixed(6),
                profit: netProfitUSDT.toFixed(4),
                commissionBNB: commissionBNB.toFixed(6),
                commissionUSDT: commissionUSDT.toFixed(4),
                profitPercent: profitPercent.toFixed(2),
                status: 'completed',
                mode: state.tradingMode,
                txHash: txHash,
                strategy: strategies[state.selectedStrategy].name,
                indicators: {
                    rsi: state.indicators.rsi.toFixed(2),
                    macd: state.indicators.macd.histogram.toFixed(4),
                    confidence: (confidence * 100).toFixed(0) + '%'
                }
            };
            
            state.trades.unshift(newTrade);
            state.trades = state.trades.slice(0, 50);
            
            state.portfolio.profit += netProfitUSDT;
            state.portfolio.commission += commissionUSDT;
            state.portfolio.profitPercent = ((state.portfolio.profit / state.tradingCapital) * 100).toFixed(2);
            
            state.totalCommissionBNB += commissionBNB;
            
            lastTradeTime = Date.now();
            
            renderTrades();
            updateUI();
            
            console.log('‚úÖ Trade ex√©cut√©:', tradeType, '@', executionPrice.toFixed(6));
        }

        function renderTrades() {
            if (state.trades.length === 0) return;
            
            const container = document.getElementById('tradesContainer');
            container.innerHTML = state.trades.map(trade => `
                <div class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg mb-2">
                    <div class="flex items-center gap-4">
                        <span class="${trade.type === 'BUY' ? 'text-green-400' : 'text-red-400'} text-2xl">
                            ${trade.type === 'BUY' ? 'üìà' : 'üìâ'}
                        </span>
                        <div>
                            <div class="flex items-center gap-2">
                                <p class="font-semibold">${trade.pair.replace('USDT', '')}/USDT</p>
                                ${trade.mode === 'real' ? '<span class="text-xs bg-orange-400/20 text-orange-400 px-2 py-0.5 rounded">R√âEL</span>' : ''}
                            </div>
                            <p class="text-xs text-gray-400">${trade.time} ‚Ä¢ ${trade.strategy} ‚Ä¢ ${trade.amount}</p>
                            <p class="text-xs text-blue-400">RSI: ${trade.indicators.rsi} | MACD: ${trade.indicators.macd} | Conf: ${trade.indicators.confidence}</p>
                            ${trade.txHash ? `<a href="https://bscscan.com/tx/${trade.txHash}" target="_blank" class="text-xs text-purple-400 hover:underline">Voir TX ‚Üó</a>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm">${trade.entryPrice}</p>
                        <p class="text-sm font-semibold ${parseFloat(trade.profit) >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${parseFloat(trade.profit) >= 0 ? '+' : ''}${trade.profit}
                        </p>
                        <p class="text-xs text-purple-400">-${trade.commissionBNB} BNB</p>
                    </div>
                </div>
            `).join('');
        }

        function updateUI() {
            // Wallet status
            if (state.isConnected) {
                document.getElementById('connectBtn').className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
                document.getElementById('walletText').textContent = `${state.account.slice(0, 6)}...${state.account.slice(-4)}`;
                document.getElementById('walletStatus').innerHTML = 'üü¢ Connect√©';
                
                document.getElementById('cryptoSelector').classList.remove('hidden');
                document.getElementById('capitalSection').classList.remove('hidden');
                
                document.getElementById('bnbBalance').textContent = state.balanceBNB;
                document.getElementById('bnbValue').textContent = (parseFloat(state.balanceBNB) * state.bnbPrice).toFixed(2);
                document.getElementById('usdtBalance').textContent = state.balanceUSDT;
                document.getElementById('availableBalance').textContent = state.balanceUSDT;
            }
            
            // Capital set
            if (state.capitalSet) {
                document.getElementById('capitalSection').classList.add('hidden');
                document.getElementById('statsCards').classList.remove('hidden');
                document.getElementById('indicatorsSection').classList.remove('hidden');
                
                document.getElementById('capitalDisplay').textContent = state.tradingCapital.toFixed(2);
                document.getElementById('balanceDisplay').textContent = state.balanceUSDT;
                
                updateTradeAmount();
                
                document.getElementById('toggleBotBtn').disabled = false;
                document.getElementById('toggleBotBtn').className = state.botRunning ? 
                    'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-red-600 hover:bg-red-700' :
                    'flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all bg-green-600 hover:bg-green-700';
            }
            
            // Trading mode
            if (state.tradingMode === 'real') {
                document.getElementById('modeInfo').textContent = '‚ö†Ô∏è Trades r√©els sur PancakeSwap';
                document.getElementById('modeDisplay').innerHTML = 'üíé R√âEL';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-orange-400';
                document.getElementById('modeText').textContent = 'PancakeSwap';
                
                const crypto = state.cryptoList.find(c => c.symbol === state.selectedCrypto);
                if (crypto && !crypto.realTradingAvailable) {
                    document.getElementById('approvalSection').classList.add('hidden');
                } else if (!state.usdtApproved && state.isConnected) {
                    document.getElementById('approvalSection').classList.remove('hidden');
                } else {
                    document.getElementById('approvalSection').classList.add('hidden');
                }
            } else {
                document.getElementById('modeInfo').textContent = '‚úÖ Pas de frais, donn√©es r√©elles';
                document.getElementById('modeDisplay').innerHTML = 'üéÆ SIM';
                document.getElementById('modeDisplay').className = 'text-xl font-bold mt-1 text-blue-400';
                document.getElementById('modeText').textContent = 'Simulation';
                document.getElementById('approvalSection').classList.add('hidden');
            }
            
            // Bot status
            if (state.botRunning) {
                document.getElementById('botIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('botText').textContent = 'Arr√™ter';
            } else {
                document.getElementById('botIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('botText').textContent = 'D√©marrer';
            }
            
            // Portfolio
            document.getElementById('profitDisplay').textContent = state.portfolio.profit.toFixed(2);
            document.getElementById('profitPercent').textContent = state.portfolio.profitPercent;
            document.getElementById('commissionBNB').textContent = state.totalCommissionBNB.toFixed(6);
            document.getElementById('commissionUSD').textContent = state.portfolio.commission.toFixed(2);
            document.getElementById('totalCommBNB').textContent = state.totalCommissionBNB.toFixed(6);
        }
    </script>
</body>
</html>
